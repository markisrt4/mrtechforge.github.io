{%- comment -%}
  Forge Breadcrumbs (GitHub Pages compatible)
  - No endswith (unsupported)
  - No regex replace
  - Uses prefix match by slicing
{%- endcomment -%}

{% assign nav_root = site.data.navigation.main | default: site.data.navigation %}
{% assign home_url = "/" | relative_url %}

{% assign current_url = page.url | default: "/" %}
{% assign current_clean = current_url | replace: "index.html", "" | replace: "//", "/" %}

{%- comment -%} Ensure leading slash {%- endcomment -%}
{% assign first_char = current_clean | slice: 0, 1 %}
{% unless first_char == "/" %}
  {% assign current_clean = "/" | append: current_clean %}
{% endunless %}

{%- comment -%} Trim trailing slash (Liquid-safe) {%- endcomment -%}
{% assign last_char = current_clean | slice: -1, 1 %}
{% if current_clean != "/" and last_char == "/" %}
  {% assign current_clean = current_clean | slice: 0, current_clean.size | minus: 1 %}
{% endif %}

{% assign top_item = nil %}
{% assign child_item = nil %}
{% assign best_len = 0 %}

{%- comment -%}
  Find best top-level nav match by longest prefix.
{%- endcomment -%}
{% if nav_root %}
  {% for item in nav_root %}
    {% assign item_url = item.url | default: "" %}
    {% assign item_clean = item_url | replace: "index.html", "" | replace: "//", "/" %}

    {% assign last_char = item_clean | slice: -1, 1 %}
    {% if item_clean != "/" and item_clean != "" and last_char == "/" %}
      {% assign item_clean = item_clean | slice: 0, item_clean.size | minus: 1 %}
    {% endif %}

    {% assign ilen = item_clean | size %}
    {% if ilen > 0 %}
      {% assign prefix = current_clean | slice: 0, ilen %}
      {% if current_clean == item_clean or (item_clean != "/" and prefix == item_clean) %}
        {% if ilen > best_len %}
          {% assign best_len = ilen %}
          {% assign top_item = item %}
          {% assign child_item = nil %}
        {% endif %}
      {% endif %}
    {% endif %}
  {% endfor %}
{% endif %}

{%- comment -%}
  Find exact child match under the selected top item.
{%- endcomment -%}
{% if top_item and top_item.children %}
  {% for child in top_item.children %}
    {% assign child_url = child.url | default: "" %}
    {% assign child_clean = child_url | replace: "index.html", "" | replace: "//", "/" %}

    {% assign last_char = child_clean | slice: -1, 1 %}
    {% if child_clean != "/" and child_clean != "" and last_char == "/" %}
      {% assign child_clean = child_clean | slice: 0, child_clean.size | minus: 1 %}
    {% endif %}

    {% if current_clean == child_clean %}
      {% assign child_item = child %}
    {% endif %}
  {% endfor %}
{% endif %}

<nav class="forge-breadcrumbs" aria-label="Breadcrumbs">
  <a href="{{ home_url }}">Home</a>

  {% if top_item and top_item.title and top_item.url and current_clean != "/" %}
    <span class="sep">/</span>
    <a href="{{ top_item.url | relative_url }}">{{ top_item.title }}</a>
  {% endif %}

  {% if child_item and child_item.title and child_item.url %}
    <span class="sep">/</span>
    <a href="{{ child_item.url | relative_url }}">{{ child_item.title }}</a>
  {% elsif current_clean != "/" and top_item == nil %}
    <span class="sep">/</span>
    <span class="current">{{ page.title }}</span>
  {% endif %}
</nav>