<header class="forge-header">
  <div class="header-inner">

    <!-- LOGO + WORDMARK -->
    <a href="{{ site.data.links.pages.home | default: '/' }}" class="logo-link">
      <img src="/assets/images/logo_transparent.png"
           alt="M.R. TechForge Logo"
           class="forge-logo">
      <h1 class="forge-title">M.R. TechForge</h1>
    </a>

    <!-- MOBILE HAMBURGER BUTTON -->
    <button class="nav-toggle-btn" aria-label="Toggle navigation">
      <svg class="forge-burger" width="36" height="26" viewBox="0 0 36 26">
        <rect class="bar bar-top"    x="3" y="3"  width="30" height="3" rx="1.5" />
        <rect class="bar bar-middle" x="3" y="11" width="30" height="3" rx="1.5" />
        <rect class="bar bar-bottom" x="3" y="19" width="30" height="3" rx="1.5" />
      </svg>
    </button>

    {% assign current_url = page.url | default: "/" %}

    <!-- NAVIGATION -->
    <nav class="forge-nav">

      {% for item in site.data.navigation.main %}

        {%- comment -%} Resolve URL from key (preferred) or url (fallback) {%- endcomment -%}
        {% assign item_url_resolved = item.url | default: "/" %}
        {% if item.key %}
          {% assign parts = item.key | split: "." %}
          {% assign group = parts[0] %}
          {% assign name  = parts[1] %}
          {% assign item_url_resolved = site.data.links[group][name] | default: item_url_resolved %}
        {% endif %}

        {% assign item_url_clean = item_url_resolved | default: "/" | split: "#" | first %}
        {% assign item_is_active =
          current_url == item_url_clean or
          (current_url != "/" and current_url contains item_url_clean)
        %}

        {% if item.children %}
          <div class="nav-item dropdown">

            <!-- TOP-LEVEL BUTTON -->
            <button
              class="dropdown-parent{% if item_is_active %} is-active-parent{% endif %}"
              type="button">
              <span class="dropdown-parent-text">{{ item.title }}</span>
              <span class="dropdown-arrow">â–¼</span>
            </button>

            <!-- DESKTOP DROPDOWN -->
            <div class="dropdown-content desktop-only">

              {% if item_url_resolved %}
                <a href="{{ item_url_resolved }}" class="dropdown-overview{% if item_is_active %} is-active{% endif %}">
                  {{ item.title }} Overview
                </a>
              {% endif %}

              {% for child in item.children %}

                {% assign child_url_resolved = child.url | default: "/" %}
                {% if child.key %}
                  {% assign cparts = child.key | split: "." %}
                  {% assign cgroup = cparts[0] %}
                  {% assign cname  = cparts[1] %}
                  {% assign child_url_resolved = site.data.links[cgroup][cname] | default: child_url_resolved %}
                {% endif %}

                {% assign child_url_clean = child_url_resolved | split: "#" | first %}
                {% assign child_is_active =
                  current_url == child_url_clean or
                  current_url contains child_url_clean
                %}

                <a href="{{ child_url_resolved }}"
                   data-child="true"
                   class="{% if child_is_active %}is-active{% endif %}">
                  {{ child.title }}
                </a>

                {% if child.children %}
                  {% for grand in child.children %}

                    {% assign grand_url_resolved = grand.url | default: "/" %}
                    {% if grand.key %}
                      {% assign gparts = grand.key | split: "." %}
                      {% assign ggroup = gparts[0] %}
                      {% assign gname  = gparts[1] %}
                      {% assign grand_url_resolved = site.data.links[ggroup][gname] | default: grand_url_resolved %}
                    {% endif %}

                    {% assign grand_url_clean = grand_url_resolved | split: "#" | first %}
                    {% assign grand_is_active =
                      current_url == grand_url_clean or
                      current_url contains grand_url_clean
                    %}

                    <a href="{{ grand_url_resolved }}"
                       data-grandchild="true"
                       class="{% if grand_is_active %}is-active{% endif %}">
                      {{ grand.title }}
                    </a>

                  {% endfor %}
                {% endif %}

              {% endfor %}
            </div>

            <!-- MOBILE ACCORDION SUBMENU -->
            <ul class="mobile-submenu">

              {% if item_url_resolved %}
                <li>
                  <a href="{{ item_url_resolved }}" class="{% if item_is_active %}is-active{% endif %}">
                    {{ item.title }} Overview
                  </a>
                </li>
              {% endif %}

              {% for child in item.children %}

                {% assign child_url_resolved = child.url | default: "/" %}
                {% if child.key %}
                  {% assign cparts = child.key | split: "." %}
                  {% assign cgroup = cparts[0] %}
                  {% assign cname  = cparts[1] %}
                  {% assign child_url_resolved = site.data.links[cgroup][cname] | default: child_url_resolved %}
                {% endif %}

                {% assign child_url_clean = child_url_resolved | split: "#" | first %}
                {% assign child_is_active =
                  current_url == child_url_clean or
                  current_url contains child_url_clean
                %}

                <li class="mobile-child">
                  <a href="{{ child_url_resolved }}" class="{% if child_is_active %}is-active{% endif %}">
                    {{ child.title }}
                  </a>
                </li>

                {% if child.children %}
                  {% for grand in child.children %}

                    {% assign grand_url_resolved = grand.url | default: "/" %}
                    {% if grand.key %}
                      {% assign gparts = grand.key | split: "." %}
                      {% assign ggroup = gparts[0] %}
                      {% assign gname  = gparts[1] %}
                      {% assign grand_url_resolved = site.data.links[ggroup][gname] | default: grand_url_resolved %}
                    {% endif %}

                    {% assign grand_url_clean = grand_url_resolved | split: "#" | first %}
                    {% assign grand_is_active =
                      current_url == grand_url_clean or
                      current_url contains grand_url_clean
                    %}

                    <li class="mobile-grandchild">
                      <a href="{{ grand_url_resolved }}" class="{% if grand_is_active %}is-active{% endif %}">
                        {{ grand.title }}
                      </a>
                    </li>

                  {% endfor %}
                {% endif %}

              {% endfor %}
            </ul>

          </div>

        {% else %}
          <a href="{{ item_url_resolved }}"
             class="{% if item_is_active %}is-active{% endif %}">
            {{ item.title }}
          </a>

        {% endif %}
      {% endfor %}

    </nav>

  </div>
</header>
