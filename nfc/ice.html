<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MRTF ICE — Smart Tag</title>
<style>
  :root{--bg:#0b0d0f;--muted:#9aaeb5;--accent:#00b8d4;--card:#111416;--text:#dfeef3}
  body{margin:0;font-family:Inter,system-ui,Roboto,Arial,sans-serif;background:linear-gradient(180deg,#071013,#0b0d0f);color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
  .card{max-width:560px;width:100%;background:var(--card);border-radius:12px;padding:20px;box-shadow:0 8px 30px rgba(0,0,0,0.6);text-align:center}
  h1{color:var(--accent);margin:0 0 8px;font-size:1.25rem}
  p{color:var(--muted);margin:0 0 16px}
  button{background:linear-gradient(90deg,#007c91,#00b8d4);border:none;color:#fff;padding:12px 18px;border-radius:10px;font-weight:600;cursor:pointer;box-shadow:0 6px 18px rgba(0,184,212,0.12)}
  .small{font-size:0.9rem;color:var(--muted);margin-top:12px}
  .link{display:block;margin-top:14px;color:#a9e8f0;word-break:break-all}
  .hidden{display:none}
</style>
</head>
<body>
  <div class="card" role="main" aria-live="polite">
    <h1>ICE Tag</h1>
    <p id="desc">Tap the button to text your ICE contact. Page will use encoded parameters if present.</p>

    <div id="controls">
      <button id="goBtn">Send ICE Text</button>
      <p id="status" class="small">Ready.</p>
    </div>

    <div id="manual" class="hidden">
      <p class="small">If automatic opening fails, tap the manual link below:</p>
      <a id="smsLink" class="link" href="#">Open SMS manually</a>
      <a id="mapsLink" class="link hidden" href="#" target="_blank" rel="noopener">Open location in Maps</a>
    </div>

    <p class="small">M.R. TechForge — we do not store your location. Everything runs locally on your device.</p>
  </div>

<script>
(function(){
  const DEFAULT_ICE_NUMBER = "+5551212"; // fallback if no ice= param
  const PARAMS = new URLSearchParams(window.location.search);
  const iceParam = PARAMS.get('ice');             // +1555...
  const coordsParam = PARAMS.get('coords');       // "lat,lon" or "none"
  const ICE_NUMBER = iceParam ? iceParam : DEFAULT_ICE_NUMBER;

  const goBtn = document.getElementById('goBtn');
  const status = document.getElementById('status');
  const manual = document.getElementById('manual');
  const smsLink = document.getElementById('smsLink');
  const mapsLink = document.getElementById('mapsLink');

  function urlEncode(s){ return encodeURIComponent(s); }
  function buildSmsUri(number, body){ return `sms:${number}?body=${urlEncode(body)}`; }

  function openUri(uri){
    window.location.href = uri;
    setTimeout(()=> manual.classList.remove('hidden'), 1200);
  }

  function useStaticCoords(coordText){
    // coordText expected "lat,lon" (simple validation)
    const parts = coordText.split(',');
    if(parts.length !== 2) return null;
    const lat = parseFloat(parts[0]);
    const lon = parseFloat(parts[1]);
    if(isNaN(lat) || isNaN(lon)) return null;
    return { lat: lat.toFixed(6), lon: lon.toFixed(6) };
  }

  async function handleSend(){
    status.textContent = "Preparing message...";
    // Case A: coords param explicitly set to "none" -> no location
    if(coordsParam && coordsParam.toLowerCase() === "none"){
      const message = `This is an emergency. Please call me.`;
      const smsUri = buildSmsUri(ICE_NUMBER, message);
      smsLink.href = smsUri;
      openUri(smsUri);
      return;
    }

    // Case B: coords param contains static coords
    if(coordsParam){
      const parsed = useStaticCoords(coordsParam);
      if(parsed){
        const mapsUrl = `https://maps.google.com/?q=${parsed.lat},${parsed.lon}`;
        const message = `This is an emergency. My location: ${mapsUrl}`;
        const smsUri = buildSmsUri(ICE_NUMBER, message);
        smsLink.href = smsUri;
        mapsLink.href = mapsUrl;
        mapsLink.classList.remove('hidden');
        openUri(smsUri);
        return;
      }
      // fallthrough to geolocation if coords param is invalid
    }

    // Case C: No coords param -> attempt browser geolocation
    if(!navigator.geolocation){
      status.textContent = "Geolocation not available — opening SMS without location.";
      const smsUri = buildSmsUri(ICE_NUMBER, "This is an emergency. Please call me!");
      smsLink.href = smsUri;
      openUri(smsUri);
      return;
    }

    status.textContent = "Requesting location permission...";
    navigator.geolocation.getCurrentPosition(pos => {
      const lat = pos.coords.latitude.toFixed(6);
      const lon = pos.coords.longitude.toFixed(6);
      const mapsUrl = `https://maps.google.com/?q=${lat},${lon}`;
      const message = `This is an emergency. My location: ${mapsUrl}`;
      const smsUri = buildSmsUri(ICE_NUMBER, message);
      smsLink.href = smsUri;
      mapsLink.href = mapsUrl;
      mapsLink.classList.remove('hidden');
      status.textContent = "Location acquired — opening SMS app...";
      openUri(smsUri);
    }, err => {
      // if user blocks location or error, fallback to SMS without coords
      status.textContent = "Location unavailable — opening SMS without location.";
      const smsUri = buildSmsUri(ICE_NUMBER, "This is an emergency. Please call me!");
      smsLink.href = smsUri;
      openUri(smsUri);
    }, { enableHighAccuracy:true, timeout:10000, maximumAge:0 });
  }

  goBtn.addEventListener('click', handleSend);

  // Pre-fill manual link if no JS action yet
  smsLink.href = buildSmsUri(ICE_NUMBER, "This is an emergency. Please call me!");
  smsLink.textContent = `Send ICE text to ${ICE_NUMBER}`;

})();
</script>
</body>
</html>